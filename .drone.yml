clone:
  git:
    image: plugins/git
    recursive: true
    submodule_update_remote: true
#    dns_search: interactive-instruments.de
#    extra_hosts:
#      - "project-management:192.168.230.8"

pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - .gradle/caches
      - .gradle/wrapper
    volumes:
      - /tmp/cache:/cache

  build:
    image: openjdk:8-alpine
#    dns_search: interactive-instruments.de
#    extra_hosts:
#      - "project-management:192.168.230.8"
    environment:
      - GRADLE_USER_HOME="${DRONE_WORKSPACE}"
    commands:
      - export  
      - apk add --no-cache bash
      - sed -i "s#https://gitlab.wetransform.to/hale/hale-build-support/raw/.*/updatesites/platform#file:$TRAVIS_BUILD_DIR/hale-platform/build/updatesite#" hale/platform/hale-platform.target
      - sed -i "s#<unit id=\"eu.esdihumboldt.hale.platform.feature.group\" version=\".*\"/>#<unit id=\"eu.esdihumboldt.hale.platform.feature.group\" version=\"0.0.0\"/>#" hale/platform/hale-platform.target
      - sed -i "s#repositories {#repositories {\\nmaven { url 'https://repo.boundlessgeo.com/main/'}#" hale-platform/build.gradle
      - echo "platform{eclipseMirror='http://dl.bintray.com/simon-scholz/eclipse-apps/eclipse-p2-minimal.tar.gz'}" >> hale-platform/build.gradle
      - cd hale-platform && ./gradlew --info --stacktrace updateSite
#      - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
#      - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
#      - cd hale && ./build.sh product --arch x86_64 --os linux HALE

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - .gradle/caches
      - .gradle/wrapper
    volumes:
      - /tmp/cache:/cache